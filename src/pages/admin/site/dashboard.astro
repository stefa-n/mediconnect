---
import MainLayout from '../../../layouts/main.astro';
import Navbar from '../../../components/Navbar.astro';
import StatsCard from '../../../components/dashboard/StatsCard.astro';
import HospitalsList from '../../../components/admin/HospitalsList.astro';
import UsersList from '../../../components/admin/UsersList.astro';

// Pass placeholder user for navbar (will be updated client-side)
const placeholderUser = { email: 'loading@example.com' };
---

<MainLayout content={{ title: 'Site Admin Dashboard - MediConnect' }}>
  <!-- Font Awesome for icons - Must load before content renders -->
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous"
    referrerPolicy="no-referrer"
  />
  
  <Navbar user={placeholderUser} />
  
  <div class="min-h-screen bg-gradient-to-br from-primary/5 via-background to-secondary/5">
    <!-- Loading State -->
    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
      <div class="relative">
        <div class="flex flex-col items-center space-y-6">
          <div class="relative">
            <div class="absolute inset-0 w-24 h-24 rounded-full bg-primary/20 animate-ping"></div>
            <div class="absolute inset-2 w-20 h-20 rounded-full bg-primary/30 animate-pulse"></div>
            <div class="relative w-24 h-24 bg-gradient-to-br from-primary to-blue-600 rounded-full flex items-center justify-center shadow-2xl">
              <i class="fas fa-shield-alt text-white text-4xl animate-pulse"></i>
            </div>
          </div>
          <div class="text-center">
            <h2 class="text-2xl font-bold text-foreground mb-2">MediConnect</h2>
            <p class="text-muted-foreground text-sm mb-4">Loading admin dashboard...</p>
            <div class="w-48 h-1.5 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-gradient-to-r from-primary to-blue-600 rounded-full animate-progress"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-3 pointer-events-none">
      <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] p-4" style="display: none; align-items: center; justify-content: center;">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all scale-95 opacity-0" id="confirm-modal-content">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div id="confirm-icon" class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center">
              <i class="fas fa-question-circle text-2xl"></i>
            </div>
            <div class="flex-1">
              <h3 id="confirm-title" class="text-xl font-bold text-gray-900 mb-2"></h3>
              <p id="confirm-message" class="text-gray-600 text-sm leading-relaxed whitespace-pre-line"></p>
            </div>
          </div>
        </div>
        <div class="px-6 pb-6 flex gap-3">
          <button 
            id="confirm-cancel-btn"
            class="flex-1 px-4 py-2.5 rounded-lg border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 font-medium text-gray-700 transition-all"
          >
            Cancel
          </button>
          <button 
            id="confirm-ok-btn"
            class="flex-1 px-4 py-2.5 rounded-lg font-medium text-white transition-all shadow-lg hover:shadow-xl transform hover:scale-105"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <main id="dashboard-content" class="hidden container mx-auto px-4 py-8">
      <!-- Welcome Section -->
      <div class="mb-8">
        <h2 class="text-3xl font-bold mb-2 text-foreground">
          Welcome, <span id="admin-name">Admin</span>!
        </h2>
        <p class="text-muted-foreground flex items-center gap-2">
          <i class="fas fa-shield-alt"></i>
          Site Administrator Dashboard
        </p>
      </div>

      <!-- Stats Grid - 4 cards in a row -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-grid">
        <div class="stats-card">
          <StatsCard 
            label="Total Hospitals" 
            value="0" 
            icon="fas fa-hospital" 
            color="text-blue-500"
            delay={0}
          />
        </div>
        <div class="stats-card">
          <StatsCard 
            label="Hospital Admins" 
            value="0" 
            icon="fas fa-user-shield" 
            color="text-green-500"
            delay={100}
          />
        </div>
        <div class="stats-card">
          <StatsCard 
            label="Site Admins" 
            value="0" 
            icon="fas fa-users-cog" 
            color="text-purple-500"
            delay={200}
          />
        </div>
        <div class="stats-card">
          <StatsCard 
            label="Total Users" 
            value="0" 
            icon="fas fa-users" 
            color="text-orange-500"
            delay={300}
          />
        </div>
      </div>

      <!-- Main Content -->
      <div class="space-y-6">
        <!-- Hospitals Section -->
        <div id="hospitals-section">
          <HospitalsList />
        </div>

        <!-- Admins Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Hospital Administrators -->
          <div id="hospital-admins-section">
            <UsersList 
              role="hospital_admin"
              title="Hospital Administrators"
            />
          </div>

          <!-- Site Administrators -->
          <div id="site-admins-section">
            <UsersList 
              role="mediconnect_admin"
              title="Site Administrators"
            />
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Hospital Modal -->
  <div id="hospital-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 p-4" style="display: none; align-items: center; justify-content: center;">
    <div id="hospital-modal-content" class="bg-card rounded-xl shadow-2xl max-w-md w-full border border-border transform transition-all scale-95 opacity-0">
      <div class="p-6 border-b border-border">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-foreground" id="hospital-modal-title">Add Hospital</h3>
          <button id="close-hospital-modal" class="text-muted-foreground hover:text-foreground transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <form id="hospital-form" class="p-6 space-y-4">
        <input type="hidden" id="hospital-id" />
        <div>
          <label class="block text-sm font-medium text-foreground mb-2">Hospital Name *</label>
          <input 
            type="text" 
            id="hospital-name" 
            required
            class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Enter hospital name"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-foreground mb-2">Address</label>
          <input 
            type="text" 
            id="hospital-address"
            class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Enter address"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-foreground mb-2">Phone</label>
          <input 
            type="tel" 
            id="hospital-phone"
            class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Enter phone number"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-foreground mb-2">Email</label>
          <input 
            type="email" 
            id="hospital-email"
            class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Enter email"
          />
        </div>
        <div class="flex gap-3 pt-4">
          <button 
            type="submit"
            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
          >
            <i class="fas fa-save mr-2"></i>
            Save Hospital
          </button>
          <button 
            type="button"
            id="cancel-hospital-btn"
            class="px-4 py-2 border border-border rounded-lg hover:bg-accent transition-colors"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div id="user-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 p-4" style="display: none; align-items: center; justify-content: center;">
    <div id="user-modal-content" class="bg-card rounded-xl shadow-2xl max-w-md w-full border border-border transform transition-all scale-95 opacity-0">
      <div class="p-6 border-b border-border">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-foreground" id="user-modal-title">Assign Role to User</h3>
          <button id="close-user-modal" class="text-muted-foreground hover:text-foreground transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="user-id" />
        <input type="hidden" id="user-role-target" />
        
        <!-- User Selection (shown when adding) -->
        <div id="user-search-section">
          <label class="block text-sm font-medium text-foreground mb-2">
            Search for User by Email
          </label>
          <div class="relative">
            <input 
              type="email" 
              id="user-email-search" 
              class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Start typing email address..."
              autocomplete="off"
            />
            <div class="absolute right-2 top-1/2 -translate-y-1/2">
              <i id="search-spinner" class="fas fa-spinner fa-spin text-primary hidden"></i>
            </div>
          </div>
          <p class="text-xs text-muted-foreground mt-2">
            ℹ️ Start typing to search for existing users
          </p>
          <div id="search-results-dropdown" class="hidden mt-1 max-h-60 overflow-y-auto border border-border rounded-lg bg-white shadow-lg"></div>
        </div>

        <!-- User Form (shown when editing or after selection) -->
        <form id="user-form" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Email</label>
            <input 
              type="email" 
              id="user-email" 
              readonly
              class="w-full px-4 py-2 border border-border rounded-lg bg-gray-50 text-gray-600"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Full Name *</label>
            <input 
              type="text" 
              id="user-fullname" 
              required
              class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Enter full name"
            />
          </div>
          <div id="role-display-container">
            <label class="block text-sm font-medium text-foreground mb-2">Assigned Role</label>
            <div class="w-full px-4 py-2 border border-border rounded-lg bg-gray-50 text-gray-700 font-medium">
              <i class="fas fa-user-shield mr-2 text-primary"></i>
              <span id="user-role-display"></span>
            </div>
          </div>
          <div id="hospital-select-container" class="hidden">
            <label class="block text-sm font-medium text-foreground mb-2">Hospital *</label>
            <select 
              id="user-hospital"
              class="w-full px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
            >
              <option value="">Select a hospital</option>
            </select>
          </div>
          <div class="flex gap-3 pt-4">
            <button 
              type="submit"
              class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
            >
              <i class="fas fa-save mr-2"></i>
              Save Changes
            </button>
            <button 
              type="button"
              id="cancel-user-btn"
              class="px-4 py-2 border border-border rounded-lg hover:bg-accent transition-colors"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    let hospitalsData: any[] = [];
    let usersData: any[] = [];

    // Custom Toast Notification System
    type ToastType = 'success' | 'error' | 'warning' | 'info';
    
    function showToast(message: string, type: ToastType = 'info', duration: number = 4000) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'pointer-events-auto transform translate-x-full transition-all duration-300 ease-out';
      
      const icons = {
        success: { icon: 'fa-check-circle', bgColor: 'bg-green-500', textColor: 'text-green-50' },
        error: { icon: 'fa-times-circle', bgColor: 'bg-red-500', textColor: 'text-red-50' },
        warning: { icon: 'fa-exclamation-triangle', bgColor: 'bg-orange-500', textColor: 'text-orange-50' },
        info: { icon: 'fa-info-circle', bgColor: 'bg-blue-500', textColor: 'text-blue-50' }
      };

      const config = icons[type];
      
      toast.innerHTML = `
        <div class="flex items-start gap-3 ${config.bgColor} ${config.textColor} px-5 py-4 rounded-xl shadow-2xl min-w-[300px] max-w-md backdrop-blur-sm border border-white/20">
          <i class="fas ${config.icon} text-xl mt-0.5 flex-shrink-0"></i>
          <p class="flex-1 font-medium leading-relaxed">${message}</p>
          <button onclick="this.closest('[class*=translate]').remove()" class="ml-2 hover:opacity-80 transition-opacity flex-shrink-0">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      `;
      
      container.appendChild(toast);
      
      // Trigger entrance animation
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
        toast.classList.add('translate-x-0');
      }, 10);
      
      // Auto remove after duration
      setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Custom Confirmation Dialog
    function showConfirm(
      title: string, 
      message: string, 
      options: {
        type?: 'danger' | 'warning' | 'info',
        confirmText?: string,
        cancelText?: string
      } = {}
    ): Promise<boolean> {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const modalContent = document.getElementById('confirm-modal-content');
        const iconEl = document.getElementById('confirm-icon');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const confirmBtn = document.getElementById('confirm-ok-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        
        if (!modal || !modalContent || !iconEl || !titleEl || !messageEl || !confirmBtn || !cancelBtn) {
          resolve(false);
          return;
        }

        const type = options.type || 'warning';
        const configs = {
          danger: { 
            icon: 'fa-exclamation-triangle', 
            iconBg: 'bg-red-100 text-red-600',
            btnBg: 'bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800'
          },
          warning: { 
            icon: 'fa-exclamation-circle', 
            iconBg: 'bg-orange-100 text-orange-600',
            btnBg: 'bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800'
          },
          info: { 
            icon: 'fa-info-circle', 
            iconBg: 'bg-blue-100 text-blue-600',
            btnBg: 'bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800'
          }
        };

        const config = configs[type];
        
        // Set content
        iconEl.className = `flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${config.iconBg}`;
        iconEl.querySelector('i')!.className = `fas ${config.icon} text-2xl`;
        titleEl.textContent = title;
        messageEl.textContent = message;
        confirmBtn.textContent = options.confirmText || 'Confirm';
        confirmBtn.className = `flex-1 px-4 py-2.5 rounded-lg font-medium text-white transition-all shadow-lg hover:shadow-xl transform hover:scale-105 ${config.btnBg}`;
        cancelBtn.textContent = options.cancelText || 'Cancel';
        
        // Show modal with animation
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        
        setTimeout(() => {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        const closeModal = (result: boolean) => {
          modalContent.classList.add('scale-95', 'opacity-0');
          modalContent.classList.remove('scale-100', 'opacity-100');
          
          setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            resolve(result);
          }, 200);
        };
        
        // Event handlers
        const handleConfirm = () => {
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          closeModal(true);
        };
        
        const handleCancel = () => {
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          closeModal(false);
        };
        
        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
      });
    }

    // Update navbar with user data
    function updateNavbar(user: any, profile: any) {
      const avatarElements = document.querySelectorAll('[class*="rounded-full"][class*="bg-gradient"]');
      const initial = profile?.full_name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'A';
      avatarElements.forEach(el => {
        if (el.textContent && el.textContent.trim().length <= 1) {
          el.textContent = initial;
        }
      });

      const dropdownContainer = document.getElementById('user-dropdown');
      if (dropdownContainer) {
        const paragraphs = dropdownContainer.querySelectorAll('p');
        if (paragraphs[0]) paragraphs[0].textContent = profile?.full_name || user.user_metadata?.full_name || 'Admin';
        if (paragraphs[1]) paragraphs[1].textContent = user.email || '';
      }
    }

    async function loadDashboardData() {
      try {
        // Check authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          console.error('Not authenticated:', authError);
          window.location.href = '/auth';
          return;
        }

        // Get user profile and verify they're a site admin
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (profileError || !profile) {
          console.error('Error fetching profile:', profileError);
          showToast('Unable to load profile', 'error');
          window.location.href = '/auth';
          return;
        }

        // Verify user is site admin
        if (profile.role !== 'mediconnect_admin') {
          showToast('Access denied. This page is for site administrators only.', 'error');
          window.location.href = '/dashboard';
          return;
        }

        // Update admin name and navbar
        const nameElement = document.getElementById('admin-name');
        if (nameElement) {
          nameElement.textContent = profile.full_name || user.email?.split('@')[0] || 'Admin';
        }
        updateNavbar(user, profile);

        // Fetch all data
        await Promise.all([
          loadHospitals(),
          loadUsers()
        ]);

        // Calculate and update stats
        updateStats();

        // Show dashboard
        const loading = document.getElementById('loading-screen');
        const content = document.getElementById('dashboard-content');
        
        if (loading) {
          loading.style.opacity = '0';
          setTimeout(() => loading.classList.add('hidden'), 300);
        }
        if (content) {
          content.classList.remove('hidden');
          setTimeout(() => content.style.opacity = '1', 100);
        }

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard. Please try again.', 'error');
      }
    }

    async function loadHospitals() {
      const { data, error } = await supabase
        .from('hospitals')
        .select('*')
        .order('name');

      if (error) {
        console.error('Error fetching hospitals:', error);
        return;
      }

      hospitalsData = data || [];
      renderHospitals();
    }

    async function loadUsers() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .in('role', ['hospital_admin', 'mediconnect_admin'])
        .order('full_name');

      if (error) {
        console.error('Error fetching users:', error);
        return;
      }

      usersData = data || [];
      renderUsers();
      updateHospitalNames();
    }

    function updateStats() {
      const statsGrid = document.getElementById('stats-grid');
      if (!statsGrid) return;

      const statCards = statsGrid.querySelectorAll('.stats-card');
      
      // Total Hospitals
      if (statCards[0]) {
        const valueEl = statCards[0].querySelector('.text-3xl');
        if (valueEl) valueEl.textContent = hospitalsData.length.toString();
      }
      
      // Hospital Admins
      if (statCards[1]) {
        const valueEl = statCards[1].querySelector('.text-3xl');
        const count = usersData.filter(u => u.role === 'hospital_admin').length;
        if (valueEl) valueEl.textContent = count.toString();
      }
      
      // Site Admins
      if (statCards[2]) {
        const valueEl = statCards[2].querySelector('.text-3xl');
        const count = usersData.filter(u => u.role === 'mediconnect_admin').length;
        if (valueEl) valueEl.textContent = count.toString();
      }
      
      // Total Users (all profiles)
      if (statCards[3]) {
        const valueEl = statCards[3].querySelector('.text-3xl');
        // This would ideally fetch total from DB, but for now use current data
        if (valueEl) valueEl.textContent = (usersData.length + 1).toString(); // +1 for current admin
      }
    }

    function renderHospitals() {
      const container = document.getElementById('hospitals-list');
      if (!container) return;

      if (hospitalsData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-muted-foreground">
            <i class="fas fa-hospital text-5xl mb-4 opacity-50"></i>
            <p class="text-lg font-medium mb-2">No hospitals yet</p>
            <p class="text-sm">Add your first hospital to get started</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="space-y-4">
          ${hospitalsData.map(hospital => `
            <div class="flex items-center justify-between p-4 rounded-lg border border-border hover:bg-accent/50 transition-colors">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                  <i class="fas fa-hospital text-primary text-xl"></i>
                </div>
                <div>
                  <p class="font-semibold text-foreground">${hospital.name}</p>
                  <p class="text-sm text-muted-foreground">${hospital.address || 'No address'}</p>
                  ${hospital.phone ? `
                    <p class="text-xs text-muted-foreground mt-1">
                      <i class="fas fa-phone text-xs mr-1"></i>
                      ${hospital.phone}
                    </p>
                  ` : ''}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button 
                  class="edit-hospital-btn px-3 py-2 text-sm border border-border rounded-lg hover:bg-accent transition-colors"
                  data-hospital-id="${hospital.id}"
                >
                  <i class="fas fa-edit mr-1"></i>
                  Edit
                </button>
                <button 
                  class="delete-hospital-btn px-3 py-2 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors"
                  data-hospital-id="${hospital.id}"
                >
                  <i class="fas fa-trash mr-1"></i>
                  Delete
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Attach event listeners
      document.querySelectorAll('.edit-hospital-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.currentTarget as HTMLElement).dataset.hospitalId;
          const hospital = hospitalsData.find(h => h.id === id);
          if (hospital) openHospitalModal(hospital);
        });
      });

      document.querySelectorAll('.delete-hospital-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.currentTarget as HTMLElement).dataset.hospitalId;
          deleteHospital(id!);
        });
      });
    }

    async function demoteUserToPatient(id: string) {
      const user = usersData.find(u => u.id === id);
      if (!user) return;

      const currentRole = getRoleDisplayName(user.role);
      
      const confirmed = await showConfirm(
        `Demote ${user.full_name || user.email}?`,
        `Current role: ${currentRole}\nNew role: Patient\n\nThis will:\n• Remove their administrator privileges\n• Clear hospital assignment\n• Give them patient-level access only\n\nContinue?`,
        { type: 'warning', confirmText: 'Demote to Patient', cancelText: 'Cancel' }
      );
      
      if (!confirmed) return;

      try {
        const { error } = await supabase
          .from('profiles')
          .update({
            role: 'patient',
            hospital_id: null // Clear hospital assignment
          })
          .eq('id', id);

        if (error) {
          console.error('Error demoting user:', error);
          if (error.code === '42501') {
            throw new Error('Permission denied. Please ensure you have site administrator privileges.');
          }
          throw new Error(error.message || 'Failed to demote user');
        }
        
        showToast(`${user.full_name || user.email} has been demoted to Patient role successfully!`, 'success');
        
        await loadUsers();
        updateStats();
      } catch (error: any) {
        console.error('Error demoting user:', error);
        showToast(error.message || 'Failed to demote user.', 'error');
      }
    }

    function getRoleDisplayName(role: string): string {
      const roleMap: Record<string, string> = {
        'mediconnect_admin': 'Site Administrator',
        'hospital_admin': 'Hospital Administrator',
        'hospital_medic': 'Hospital Medic',
        'patient': 'Patient'
      };
      return roleMap[role] || role;
    }

    function renderUsers() {
      const hospitalAdmins = usersData.filter(u => u.role === 'hospital_admin');
      const siteAdmins = usersData.filter(u => u.role === 'mediconnect_admin');

      renderUserList('hospital-admins-section', hospitalAdmins, 'hospital_admin');
      renderUserList('site-admins-section', siteAdmins, 'mediconnect_admin');
    }

    function renderUserList(containerId: string, users: any[], role: string) {
      const section = document.getElementById(containerId);
      if (!section) return;

      const listContainer = section.querySelector(`#${role}-list`);
      if (!listContainer) return;

      const roleLabel = role === 'hospital_admin' ? 'Hospital Administrator' : 'Site Administrator';

      if (users.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-12 text-muted-foreground">
            <i class="fas fa-users text-5xl mb-4 opacity-50"></i>
            <p class="text-lg font-medium mb-2">No ${roleLabel.toLowerCase()}s yet</p>
            <p class="text-sm">Add your first ${roleLabel.toLowerCase()} to get started</p>
          </div>
        `;
        return;
      }

      listContainer.innerHTML = `
        <div class="space-y-3">
          ${users.map(user => `
            <div class="flex items-center justify-between p-4 rounded-lg border border-border hover:bg-accent/50 transition-colors">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white font-semibold">
                  ${user.full_name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'U'}
                </div>
                <div>
                  <p class="font-semibold text-foreground">${user.full_name || 'No name'}</p>
                  <p class="text-sm text-muted-foreground">${user.email}</p>
                  ${user.hospital_id ? `
                    <p class="text-xs text-muted-foreground mt-1">
                      <i class="fas fa-hospital text-xs mr-1"></i>
                      <span class="hospital-name" data-hospital-id="${user.hospital_id}">Loading...</span>
                    </p>
                  ` : ''}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button 
                  class="edit-user-btn px-3 py-2 text-sm border border-border rounded-lg hover:bg-accent transition-colors"
                  data-user-id="${user.id}"
                  data-role="${role}"
                  title="Edit user details"
                >
                  <i class="fas fa-edit mr-1"></i>
                  Edit
                </button>
                <button 
                  class="demote-user-btn px-3 py-2 text-sm text-orange-600 border border-orange-200 rounded-lg hover:bg-orange-50 transition-colors"
                  data-user-id="${user.id}"
                  title="Remove admin role and make patient"
                >
                  <i class="fas fa-user-minus mr-1"></i>
                  Demote
                </button>
                <button 
                  class="delete-user-btn px-3 py-2 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors"
                  data-user-id="${user.id}"
                  title="Delete user permanently"
                >
                  <i class="fas fa-trash mr-1"></i>
                  Delete
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Attach event listeners
      document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.currentTarget as HTMLElement).dataset.userId;
          const role = (e.currentTarget as HTMLElement).dataset.role;
          const user = usersData.find(u => u.id === id);
          if (user) openUserModal(user, role!);
        });
      });

      document.querySelectorAll('.demote-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.currentTarget as HTMLElement).dataset.userId;
          demoteUserToPatient(id!);
        });
      });

      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.currentTarget as HTMLElement).dataset.userId;
          deleteUser(id!);
        });
      });
    }

    function updateHospitalNames() {
      document.querySelectorAll('.hospital-name').forEach(el => {
        const hospitalId = el.getAttribute('data-hospital-id');
        const hospital = hospitalsData.find(h => h.id === hospitalId);
        if (hospital) {
          el.textContent = hospital.name;
        } else {
          el.textContent = 'Unknown Hospital';
        }
      });
    }

    // Modal functions
    function openHospitalModal(hospital?: any) {
      const modal = document.getElementById('hospital-modal');
      const modalContent = document.getElementById('hospital-modal-content');
      const title = document.getElementById('hospital-modal-title');
      const form = document.getElementById('hospital-form') as HTMLFormElement;
      
      if (!modal || !modalContent || !title || !form) return;

      if (hospital) {
        title.textContent = 'Edit Hospital';
        (document.getElementById('hospital-id') as HTMLInputElement).value = hospital.id;
        (document.getElementById('hospital-name') as HTMLInputElement).value = hospital.name;
        (document.getElementById('hospital-address') as HTMLInputElement).value = hospital.address || '';
        (document.getElementById('hospital-phone') as HTMLInputElement).value = hospital.phone || '';
        (document.getElementById('hospital-email') as HTMLInputElement).value = hospital.email || '';
      } else {
        title.textContent = 'Add Hospital';
        form.reset();
      }

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      
      // Trigger animation
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    // User search cache
    let userSearchCache: Record<string, any[]> = {};
    let searchDebounceTimer: number | null = null;

    function openUserModal(user?: any, role?: string) {
      const modal = document.getElementById('user-modal');
      const modalContent = document.getElementById('user-modal-content');
      const title = document.getElementById('user-modal-title');
      const form = document.getElementById('user-form') as HTMLFormElement;
      const hospitalContainer = document.getElementById('hospital-select-container');
      const userSearchSection = document.getElementById('user-search-section');
      const searchResultsDropdown = document.getElementById('search-results-dropdown');
      
      if (!modal || !modalContent || !title || !form) return;

      const roleLabel = role === 'hospital_admin' ? 'Hospital Administrator' : 'Site Administrator';
      
      // Store target role
      (document.getElementById('user-role-target') as HTMLInputElement).value = role || '';
      const roleDisplayElement = document.getElementById('user-role-display');
      if (roleDisplayElement) {
        roleDisplayElement.textContent = roleLabel;
      }

      if (user) {
        // Editing existing user
        title.textContent = `Edit ${roleLabel}`;
        userSearchSection?.classList.add('hidden');
        form.classList.remove('hidden');
        
        (document.getElementById('user-id') as HTMLInputElement).value = user.id;
        (document.getElementById('user-email') as HTMLInputElement).value = user.email;
        (document.getElementById('user-fullname') as HTMLInputElement).value = user.full_name || '';
        
        if (user.hospital_id) {
          (document.getElementById('user-hospital') as HTMLSelectElement).value = user.hospital_id;
        }
      } else {
        // Adding new user - show search first
        title.textContent = `Assign ${roleLabel} Role`;
        userSearchSection?.classList.remove('hidden');
        form.classList.add('hidden');
        form.reset();
        
        if (searchResultsDropdown) {
          searchResultsDropdown.innerHTML = '';
          searchResultsDropdown.classList.add('hidden');
        }
        (document.getElementById('user-email-search') as HTMLInputElement).value = '';
        (document.getElementById('user-id') as HTMLInputElement).value = '';
      }

      // Show/hide hospital select based on role
      if (role === 'hospital_admin') {
        hospitalContainer?.classList.remove('hidden');
        populateHospitalSelect();
      } else {
        hospitalContainer?.classList.add('hidden');
      }

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      
      // Trigger animation
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function populateHospitalSelect() {
      const select = document.getElementById('user-hospital') as HTMLSelectElement;
      if (!select) return;

      select.innerHTML = '<option value="">Select a hospital</option>' +
        hospitalsData.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
    }

    function closeHospitalModal() {
      const modal = document.getElementById('hospital-modal');
      const modalContent = document.getElementById('hospital-modal-content');
      
      if (modal && modalContent) {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.style.display = 'none';
        }, 200);
      }
    }

    function closeUserModal() {
      const modal = document.getElementById('user-modal');
      const modalContent = document.getElementById('user-modal-content');
      
      if (modal && modalContent) {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.style.display = 'none';
        }, 200);
      }
    }

    async function saveHospital(e: Event) {
      e.preventDefault();
      
      const id = (document.getElementById('hospital-id') as HTMLInputElement).value;
      const name = (document.getElementById('hospital-name') as HTMLInputElement).value;
      const address = (document.getElementById('hospital-address') as HTMLInputElement).value;
      const phone = (document.getElementById('hospital-phone') as HTMLInputElement).value;
      const email = (document.getElementById('hospital-email') as HTMLInputElement).value;

      const hospitalData = { name, address, phone, email };

      try {
        if (id) {
          // Update existing
          const { error } = await supabase
            .from('hospitals')
            .update(hospitalData)
            .eq('id', id);

          if (error) {
            console.error('Error updating hospital:', error);
            throw new Error(error.message || 'Failed to update hospital');
          }
          showToast('Hospital updated successfully!', 'success');
        } else {
          // Create new
          const { error } = await supabase
            .from('hospitals')
            .insert(hospitalData);

          if (error) {
            console.error('Error creating hospital:', error);
            if (error.code === '42501') {
              throw new Error('Permission denied. Please ensure you have site administrator privileges.');
            }
            throw new Error(error.message || 'Failed to create hospital');
          }
          showToast('Hospital added successfully!', 'success');
        }

        closeHospitalModal();
        await loadHospitals();
        updateStats();
      } catch (error: any) {
        console.error('Error saving hospital:', error);
        showToast(error.message || 'Failed to save hospital. Please try again.', 'error');
      }
    }

    async function saveUser(e: Event) {
      e.preventDefault();
      
      const id = (document.getElementById('user-id') as HTMLInputElement).value;
      const targetRole = (document.getElementById('user-role-target') as HTMLInputElement).value;
      const email = (document.getElementById('user-email') as HTMLInputElement).value;
      const fullName = (document.getElementById('user-fullname') as HTMLInputElement).value;
      const hospitalId = (document.getElementById('user-hospital') as HTMLSelectElement).value;

      if (!id) {
        showToast('No user selected. Please search for a user first.', 'error');
        return;
      }

      // Validate hospital selection for hospital roles
      if (targetRole === 'hospital_admin' && !hospitalId) {
        showToast('Please select a hospital for Hospital Administrator role', 'warning');
        return;
      }

      // Update user profile
      const userData: any = { 
        email, 
        full_name: fullName,
        role: targetRole
      };

      if (targetRole === 'hospital_admin' && hospitalId) {
        userData.hospital_id = hospitalId;
      } else if (targetRole === 'mediconnect_admin') {
        userData.hospital_id = null; // Site admins don't need a hospital
      }

      try {
        const { error } = await supabase
          .from('profiles')
          .update(userData)
          .eq('id', id);

        if (error) {
          console.error('Error updating user:', error);
          if (error.code === '42501') {
            throw new Error('Permission denied. Please ensure you have site administrator privileges.');
          }
          throw new Error(error.message || 'Failed to update user');
        }
        showToast('User role assigned successfully!', 'success');
        
        closeUserModal();
        await loadUsers();
        updateStats();
      } catch (error: any) {
        console.error('Error saving user:', error);
        showToast(error.message || 'Failed to save user. Please try again.', 'error');
      }
    }

    async function deleteHospital(id: string) {
      const confirmed = await showConfirm(
        'Delete Hospital?',
        'Are you sure you want to delete this hospital?\n\nThis action cannot be undone.',
        { type: 'danger', confirmText: 'Delete', cancelText: 'Cancel' }
      );
      
      if (!confirmed) return;

      try {
        const { error } = await supabase
          .from('hospitals')
          .delete()
          .eq('id', id);

        if (error) {
          console.error('Error deleting hospital:', error);
          if (error.code === '23503') {
            throw new Error('Cannot delete hospital. It is currently assigned to administrators. Please reassign them first.');
          }
          if (error.code === '42501') {
            throw new Error('Permission denied. Please ensure you have site administrator privileges.');
          }
          throw new Error(error.message || 'Failed to delete hospital');
        }
        showToast('Hospital deleted successfully!', 'success');
        
        await loadHospitals();
        await loadUsers(); // Reload users in case any were affected
        updateStats();
      } catch (error: any) {
        console.error('Error deleting hospital:', error);
        showToast(error.message || 'Failed to delete hospital.', 'error');
      }
    }

    async function deleteUser(id: string) {
      const confirmed = await showConfirm(
        'Delete User?',
        'Are you sure you want to delete this user?\n\nThis will remove their profile and access to the system.\n\nThis action cannot be undone.',
        { type: 'danger', confirmText: 'Delete', cancelText: 'Cancel' }
      );
      
      if (!confirmed) return;

      try {
        const { error } = await supabase
          .from('profiles')
          .delete()
          .eq('id', id);

        if (error) {
          console.error('Error deleting user:', error);
          if (error.code === '42501') {
            throw new Error('Permission denied. Please ensure you have site administrator privileges.');
          }
          throw new Error(error.message || 'Failed to delete user');
        }
        showToast('User deleted successfully!', 'success');
        
        await loadUsers();
        updateStats();
      } catch (error: any) {
        console.error('Error deleting user:', error);
        showToast(error.message || 'Failed to delete user.', 'error');
      }
    }

    async function liveSearchUsers(query: string) {
      const dropdown = document.getElementById('search-results-dropdown');
      const spinner = document.getElementById('search-spinner');
      
      if (!dropdown || !spinner) return;

      // Clear if query is too short
      if (query.length < 2) {
        dropdown.classList.add('hidden');
        dropdown.innerHTML = '';
        return;
      }

      // Check cache first
      const cacheKey = query.toLowerCase();
      if (userSearchCache[cacheKey]) {
        displaySearchResults(userSearchCache[cacheKey], dropdown);
        return;
      }

      // Show loading
      spinner.classList.remove('hidden');

      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, email, full_name, role, hospital_id')
          .ilike('email', `%${query}%`)
          .limit(10);

        spinner.classList.add('hidden');

        if (error) {
          console.error('Error searching users:', error);
          dropdown.innerHTML = '<div class="p-3 text-sm text-red-600">❌ Error searching users</div>';
          dropdown.classList.remove('hidden');
          return;
        }

        // Cache results
        userSearchCache[cacheKey] = profiles || [];
        displaySearchResults(profiles || [], dropdown);

      } catch (error) {
        console.error('Error in live search:', error);
        spinner.classList.add('hidden');
        dropdown.innerHTML = '<div class="p-3 text-sm text-red-600">❌ Search failed</div>';
        dropdown.classList.remove('hidden');
      }
    }

    function displaySearchResults(profiles: any[], dropdown: HTMLElement) {
      if (profiles.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-sm text-gray-500">No users found</div>';
        dropdown.classList.remove('hidden');
        return;
      }

      // Filter out users who already have admin roles
      const availableProfiles = profiles.filter(p => p.role === 'patient');

      if (availableProfiles.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-sm text-yellow-600">No eligible users found. Only patients can be assigned administrator roles.</div>';
        dropdown.classList.remove('hidden');
        return;
      }

      dropdown.innerHTML = availableProfiles.map(profile => `
        <div 
          class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
          data-user-id="${profile.id}"
          data-user-email="${profile.email}"
          data-user-name="${profile.full_name || ''}"
          data-user-role="${profile.role}"
          data-user-hospital="${profile.hospital_id || ''}"
          onclick="selectUserFromSearch(this)"
        >
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">${profile.email}</p>
              ${profile.full_name ? `<p class="text-xs text-gray-500 mt-0.5">${profile.full_name}</p>` : ''}
              <p class="text-xs text-gray-400 mt-0.5">
                <i class="fas fa-user-tag mr-1"></i>${getRoleDisplayName(profile.role)}
              </p>
            </div>
            <i class="fas fa-chevron-right text-gray-400 text-xs mt-1"></i>
          </div>
        </div>
      `).join('');
      
      dropdown.classList.remove('hidden');
    }

    function selectUserFromSearch(element: HTMLElement) {
      const userId = element.dataset.userId;
      const email = element.dataset.userEmail;
      const fullName = element.dataset.userName;
      const hospitalId = element.dataset.userHospital;

      // Populate form
      (document.getElementById('user-id') as HTMLInputElement).value = userId || '';
      (document.getElementById('user-email') as HTMLInputElement).value = email || '';
      (document.getElementById('user-fullname') as HTMLInputElement).value = fullName || '';
      
      if (hospitalId) {
        (document.getElementById('user-hospital') as HTMLSelectElement).value = hospitalId;
      }

      // Hide search, show form
      const userSearchSection = document.getElementById('user-search-section');
      const userForm = document.getElementById('user-form');
      const dropdown = document.getElementById('search-results-dropdown');
      
      userSearchSection?.classList.add('hidden');
      userForm?.classList.remove('hidden');
      dropdown?.classList.add('hidden');
    }

    // Make function global for onclick
    (window as any).selectUserFromSearch = selectUserFromSearch;

    async function searchUser() {
      // This function is now deprecated but kept for compatibility
      const emailInput = document.getElementById('user-email-search') as HTMLInputElement;
      const email = emailInput.value.trim();
      
      if (email.length >= 2) {
        await liveSearchUsers(email);
      }
    }

    // Event listeners
    document.getElementById('add-hospital-btn')?.addEventListener('click', () => openHospitalModal());
    document.getElementById('close-hospital-modal')?.addEventListener('click', closeHospitalModal);
    document.getElementById('cancel-hospital-btn')?.addEventListener('click', closeHospitalModal);
    document.getElementById('hospital-form')?.addEventListener('submit', saveHospital);

    document.getElementById('add-hospital_admin-btn')?.addEventListener('click', () => openUserModal(undefined, 'hospital_admin'));
    document.getElementById('add-mediconnect_admin-btn')?.addEventListener('click', () => openUserModal(undefined, 'mediconnect_admin'));
    document.getElementById('close-user-modal')?.addEventListener('click', closeUserModal);
    document.getElementById('cancel-user-btn')?.addEventListener('click', closeUserModal);
    document.getElementById('user-form')?.addEventListener('submit', saveUser);
    
    // Live search with debouncing
    const searchInput = document.getElementById('user-email-search') as HTMLInputElement;
    searchInput?.addEventListener('input', (e: Event) => {
      const target = e.target as HTMLInputElement;
      const query = target.value.trim();
      
      // Clear previous timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }
      
      // Debounce search - wait 300ms after user stops typing
      searchDebounceTimer = window.setTimeout(() => {
        liveSearchUsers(query);
      }, 300);
    });

    // Click outside dropdown to close
    document.addEventListener('click', (e: Event) => {
      const dropdown = document.getElementById('search-results-dropdown');
      const searchInput = document.getElementById('user-email-search');
      const target = e.target as HTMLElement;
      
      if (dropdown && !dropdown.contains(target) && target !== searchInput) {
        dropdown.classList.add('hidden');
      }
    });

    // Load dashboard on page load
    loadDashboardData();
  </script>

  <style>
    @keyframes progress {
      0% { width: 0%; }
      100% { width: 100%; }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .animate-progress {
      animation: progress 1.5s ease-in-out infinite;
    }

    #dashboard-content {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    #loading-screen {
      transition: opacity 0.3s ease-in-out;
    }

    #stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    @media (min-width: 1024px) {
      #stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Toast container animations */
    #toast-container > div {
      animation: slideInRight 0.3s ease-out forwards;
    }

    /* Modal backdrop blur */
    #confirm-modal {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* Smooth modal content animations */
    #confirm-modal-content {
      transition: transform 0.2s ease-out, opacity 0.2s ease-out;
    }

    /* Edit modal animations */
    #hospital-modal-content,
    #user-modal-content {
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  opacity 0.2s ease-out;
    }

    #hospital-modal,
    #user-modal {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* Button pop-in animations */
    .edit-user-btn,
    .demote-user-btn,
    .delete-user-btn,
    .edit-hospital-btn,
    .delete-hospital-btn {
      animation: scaleIn 0.3s ease-out backwards;
      transition: all 0.2s ease;
    }

    .edit-user-btn:hover,
    .edit-hospital-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .demote-user-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    }

    .delete-user-btn:hover,
    .delete-hospital-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    /* Stagger animation delays for buttons in each row */
    .edit-user-btn {
      animation-delay: 0.05s;
    }

    .demote-user-btn {
      animation-delay: 0.1s;
    }

    .delete-user-btn,
    .delete-hospital-btn {
      animation-delay: 0.15s;
    }
  </style>
</MainLayout>
